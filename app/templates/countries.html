{% extends "base.html" %}
{% set active_nav = "countries" %}

{% block title %}Countries - The Mubi 1000{% endblock %}
{% block heading %}Countries{% endblock %}
{% block subheading %}Browse the Mubi 1000 by country{% endblock %}

{% block content %}
    <!-- Search -->
    <section class="bg-gray-800 rounded-lg shadow-md p-4 mb-8">
        <input type="text" id="searchInput"
               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-100"
               placeholder="Search countries...">
    </section>

    <!-- Loading -->
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-400">Loading countries...</p>
    </div>

    <!-- Countries List -->
    <section id="countriesContent" class="bg-gray-800 rounded-lg shadow-md p-6 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-100"><span id="countryCount">0</span> Countries</h2>
        </div>
        <div id="countriesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>
{% endblock %}

{% block scripts %}
<script>
    let allCountries = [];

    async function loadCountries() {
        try {
            const countries = await apiFetch(BASE + '/api/countries');

            allCountries = countries;
            displayCountries(countries);

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('countriesContent').classList.remove('hidden');

        } catch (error) {
            console.error('Error loading countries:', error);
            alert(error.message);
        }
    }

    function displayCountries(countries) {
        const container = document.getElementById('countriesList');
        document.getElementById('countryCount').textContent = countries.length;

        container.innerHTML = countries.map(c => `
            <a href="${BASE}/country/${encodeURIComponent(c.name)}"
               class="country-card flex justify-between items-center bg-gray-700 rounded-lg p-4">
                <span class="text-gray-100 font-medium">${c.name}</span>
                <span class="text-blue-400 bg-blue-900 px-2 py-1 rounded text-sm">${c.count} film${c.count !== 1 ? 's' : ''}</span>
            </a>
        `).join('');
    }

    function filterCountries(query) {
        query = query.toLowerCase();
        const filtered = allCountries.filter(c => c.name.toLowerCase().includes(query));
        displayCountries(filtered);
    }

    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterCountries(e.target.value);
    });

    document.addEventListener('DOMContentLoaded', loadCountries);
</script>
{% endblock %}
